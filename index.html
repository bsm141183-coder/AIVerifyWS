<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Проверка работы с ИИ</title>
  <style>
    :root{
      --bg1:#eaf6ff;
      --bg2:#d7efff;
      --card: rgba(255,255,255,0.68);
      --card2: rgba(255,255,255,0.55);
      --stroke: rgba(20,60,90,0.14);
      --text:#10324a;
      --muted: rgba(16,50,74,0.72);
      --primary:#2b7bbb;
      --primary2:#1e5f93;
      --shadow: 0 14px 40px rgba(18,55,86,0.12);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 700px at 10% 10%, #ffffff 0%, var(--bg1) 35%, var(--bg2) 100%);
      min-height:100vh;
    }
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 28px 16px 48px;
    }
    .hero{
      display:flex;
      gap:16px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      padding: 18px 18px;
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(180deg, var(--card), var(--card2));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .title{
      min-width: 260px;
    }
    h1{
      margin:0 0 8px;
      font-size: 24px;
      letter-spacing: 0.2px;
    }
    .subtitle{
      margin:0;
      color: var(--muted);
      line-height:1.35;
      max-width: 720px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size: 12px;
      color: rgba(16,50,74,0.8);
      border: 1px solid var(--stroke);
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.55);
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr 0.95fr;
      gap: 16px;
      margin-top: 16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
    }

    .card{
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(180deg, var(--card), var(--card2));
      box-shadow: var(--shadow);
      padding: 16px;
      backdrop-filter: blur(10px);
    }
    .card h2{
      margin: 0 0 10px;
      font-size: 16px;
    }
    .muted{color: var(--muted)}
    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .filebox{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 12px;
      border-radius: 14px;
      border: 1px dashed rgba(43,123,187,0.45);
      background: rgba(255,255,255,0.52);
    }
    input[type="file"]{
      max-width: 100%;
    }
    .btn{
      appearance:none;
      border: 1px solid rgba(43,123,187,0.35);
      background: linear-gradient(180deg, rgba(43,123,187,0.16), rgba(43,123,187,0.08));
      color: var(--primary2);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 600;
    }
    .btn:hover{filter: brightness(0.98)}
    .btn.primary{
      border-color: rgba(43,123,187,0.55);
      background: linear-gradient(180deg, rgba(43,123,187,0.22), rgba(43,123,187,0.12));
      color: var(--primary2);
    }
    .btn.danger{
      border-color: rgba(190,60,60,0.35);
      background: linear-gradient(180deg, rgba(190,60,60,0.12), rgba(190,60,60,0.06));
      color: rgba(130,30,30,0.95);
    }
    .btn:disabled{
      opacity:0.55;
      cursor:not-allowed;
    }
    .small{
      font-size: 12px;
      color: var(--muted);
    }
    .sep{
      height:1px;
      background: rgba(16,50,74,0.10);
      margin: 12px 0;
    }

    table{
      width: 100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(16,50,74,0.12);
      background: rgba(255,255,255,0.55);
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(16,50,74,0.10);
      vertical-align: top;
      font-size: 13px;
    }
    th{
      text-align:left;
      font-size: 12px;
      color: rgba(16,50,74,0.78);
      background: rgba(43,123,187,0.08);
    }
    tr:last-child td{border-bottom:none}
    .score{
      font-variant-numeric: tabular-nums;
      font-weight:700;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(16,50,74,0.14);
      background: rgba(255,255,255,0.55);
    }
    .total{
      font-size: 18px;
      font-weight: 800;
      color: var(--primary2);
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      color: rgba(16,50,74,0.84);
      white-space: pre-wrap;
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(16,50,74,0.12);
      border-radius: 14px;
      padding: 10px;
      max-height: 240px;
      overflow:auto;
    }
    .hint{
      border-left: 4px solid rgba(43,123,187,0.45);
      padding: 10px 12px;
      background: rgba(255,255,255,0.52);
      border-radius: 12px;
      color: rgba(16,50,74,0.84);
      font-size: 13px;
      line-height: 1.45;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <div class="title">
        <h1>Проверка работы с ИИ</h1>
        <p class="subtitle">
          Загрузите HTML-файл студента, нажмите <b>«Проверить»</b> (локально) или <b>«Проверить с ИИ»</b> (при подключённом сервере),
          получите отчёт в виде таблицы: баллы по критериям, общий балл и пояснения.
        </p>
      </div>
      <div class="row">
        <span class="pill">Формат: один файл</span>
        <span class="pill">Подходит для GitHub Pages</span>
        <span class="pill">Тема: светло-голубая</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Загрузка работы</h2>

        <div class="filebox">
          <div style="flex:1">
            <div class="muted" style="margin-bottom:6px">Загрузите файл</div>
            <input id="fileInput" type="file" accept=".html,.htm,text/html" />
            <div class="small" id="fileMeta">Файл не выбран</div>
          </div>

          <div class="row">
            <button class="btn primary" id="btnCheck" disabled>Проверить</button>
            <button class="btn" id="btnCheckAI" disabled title="Требуется /api/grade на сервере">Проверить с ИИ</button>
            <button class="btn danger" id="btnReset" disabled>Сброс</button>
          </div>
        </div>

        <div class="sep"></div>

        <div class="hint">
          <b>Как работает локальная проверка:</b>
          сайт анализирует структуру HTML и базовые требования (наличие html/head/body/title/h1/p, корректная базовая структура,
          ссылки/изображения/alt, ошибки парсинга). Это быстрый и безопасный режим для публикации на GitHub Pages.
        </div>

        <div class="sep"></div>

        <h2>Текст работы (фрагмент)</h2>
        <div class="mono" id="preview">Здесь появится содержимое загруженного HTML-файла (первые ~4000 символов).</div>
      </div>

      <div class="card">
        <h2>Отчёт о проверке</h2>

        <div class="row" style="justify-content:space-between;margin-bottom:10px">
          <span class="badge">
            <span class="muted">Общий балл:</span>
            <span class="total" id="totalScore">—</span>
            <span class="muted">/</span>
            <span class="total" id="totalMax">100</span>
          </span>

          <button class="btn" id="btnDownload" disabled>Скачать отчёт (CSV)</button>
        </div>

        <table>
          <thead>
            <tr>
              <th style="width:34%">Критерий</th>
              <th style="width:12%">Баллы</th>
              <th style="width:12%">Макс.</th>
              <th>Пояснение</th>
            </tr>
          </thead>
          <tbody id="reportBody">
            <tr>
              <td colspan="4" class="muted">Пока нет данных. Загрузите файл и нажмите «Проверить».</td>
            </tr>
          </tbody>
        </table>

        <div class="sep"></div>

        <h2>Журнал проверки</h2>
        <div class="mono" id="log">—</div>

        <div class="sep"></div>

        <div class="small">
          Кнопка <b>«Проверить с ИИ»</b> отправляет результат на <span class="mono" style="display:inline-block;padding:2px 6px">/api/grade</span>.
          Это сделано специально, чтобы <b>не хранить API-ключ</b> в браузере.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ----------------------------
    // Настраиваемая рубрика (100 баллов)
    // Можно менять формулировки и веса под ваши критерии
    // ----------------------------
    const RUBRIC = [
      { id: "base-tags", name: "Базовые теги (html/head/body/title/h1/p)", max: 30 },
      { id: "structure", name: "Структура и читабельность (иерархия, заголовки, абзацы)", max: 25 },
      { id: "content", name: "Содержательность главной страницы (тема/назначение)", max: 20 },
      { id: "links-media", name: "Ссылки/изображения (корректность, alt)", max: 15 },
      { id: "validity", name: "Отсутствие грубых ошибок (парсинг, пустые блоки)", max: 10 },
    ];

    const els = {
      fileInput: document.getElementById("fileInput"),
      fileMeta: document.getElementById("fileMeta"),
      btnCheck: document.getElementById("btnCheck"),
      btnCheckAI: document.getElementById("btnCheckAI"),
      btnReset: document.getElementById("btnReset"),
      btnDownload: document.getElementById("btnDownload"),
      preview: document.getElementById("preview"),
      reportBody: document.getElementById("reportBody"),
      totalScore: document.getElementById("totalScore"),
      totalMax: document.getElementById("totalMax"),
      log: document.getElementById("log"),
    };

    let loaded = {
      filename: null,
      text: null,
      lastReport: null
    };

    function setLog(lines){
      els.log.textContent = Array.isArray(lines) ? lines.join("\n") : String(lines ?? "—");
    }

    function resetAll(){
      loaded = { filename: null, text: null, lastReport: null };
      els.fileInput.value = "";
      els.fileMeta.textContent = "Файл не выбран";
      els.preview.textContent = "Здесь появится содержимое загруженного HTML-файла (первые ~4000 символов).";
      els.totalScore.textContent = "—";
      els.totalMax.textContent = "100";
      els.reportBody.innerHTML = `<tr><td colspan="4" class="muted">Пока нет данных. Загрузите файл и нажмите «Проверить».</td></tr>`;
      setLog("—");
      els.btnCheck.disabled = true;
      els.btnCheckAI.disabled = true;
      els.btnReset.disabled = true;
      els.btnDownload.disabled = true;
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function safeTextPreview(text, maxLen=4000){
      if (!text) return "";
      return text.length > maxLen ? text.slice(0, maxLen) + "\n\n…(обрезано)..." : text;
    }

    function scoreLocal(htmlText){
      const log = [];
      const results = [];

      // Парсинг
      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlText, "text/html");

      // Проверка ошибок парсинга (в браузерах ошибки часто попадают в <parsererror> только для XML,
      // но для HTML можно косвенно оценить по наличию основных элементов)
      const hasHTML = !!doc.querySelector("html");
      const hasHead = !!doc.querySelector("head");
      const hasBody = !!doc.querySelector("body");

      const hasTitle = !!doc.querySelector("title") && (doc.querySelector("title").textContent.trim().length > 0);
      const hasH1 = !!doc.querySelector("h1") && (doc.querySelector("h1").textContent.trim().length > 0);
      const hasP = doc.querySelectorAll("p").length > 0;

      // 1) Базовые теги
      let base = 0;
      const baseNotes = [];
      if (hasHTML) { base += 6; } else { baseNotes.push("Нет тега <html>."); }
      if (hasHead) { base += 6; } else { baseNotes.push("Нет тега <head>."); }
      if (hasBody) { base += 6; } else { baseNotes.push("Нет тега <body>."); }
      if (hasTitle) { base += 6; } else { baseNotes.push("Нет <title> или он пустой."); }
      if (hasH1) { base += 4; } else { baseNotes.push("Нет <h1> или он пустой."); }
      if (hasP) { base += 2; } else { baseNotes.push("Нет ни одного <p>."); }

      base = clamp(base, 0, 30);
      results.push({
        id: "base-tags",
        name: RUBRIC.find(r=>r.id==="base-tags").name,
        score: base,
        max: 30,
        comment: baseNotes.length ? baseNotes.join(" ") : "Базовые теги присутствуют."
      });

      // 2) Структура и читабельность
      let structure = 0;
      const structureNotes = [];

      const headings = doc.querySelectorAll("h1,h2,h3");
      const paragraphs = doc.querySelectorAll("p");
      const lists = doc.querySelectorAll("ul,ol");
      const hasSections = doc.querySelectorAll("header,main,footer,section,nav,article").length > 0;

      if (headings.length >= 1) structure += 8; else structureNotes.push("Не хватает заголовков (h1/h2/h3).");
      if (paragraphs.length >= 2) structure += 8; else structureNotes.push("Рекомендуется 2+ абзаца (<p>) для читабельности.");
      if (lists.length >= 1) structure += 4;
      if (hasSections) structure += 5;

      structure = clamp(structure, 0, 25);
      results.push({
        id: "structure",
        name: RUBRIC.find(r=>r.id==="structure").name,
        score: structure,
        max: 25,
        comment: structureNotes.length ? structureNotes.join(" ") : "Структура выглядит логично."
      });

      // 3) Содержательность (простейшая эвристика по длине текста)
      let content = 0;
      const contentNotes = [];

      const text = (doc.body?.innerText || "").replace(/\s+/g, " ").trim();
      if (text.length >= 300) content += 20;
      else if (text.length >= 180) content += 15;
      else if (text.length >= 100) content += 10;
      else if (text.length >= 50) content += 6;
      else content += 0;

      if (text.length < 120) contentNotes.push("Текста мало: добавьте описание назначения сайта/организации/тематики.");
      if (!hasH1) contentNotes.push("Главный заголовок (h1) обязателен для смыслового центра страницы.");

      results.push({
        id: "content",
        name: RUBRIC.find(r=>r.id==="content").name,
        score: clamp(content, 0, 20),
        max: 20,
        comment: contentNotes.length ? contentNotes.join(" ") : "Содержательность достаточная."
      });

      // 4) Ссылки/изображения
      let media = 0;
      const mediaNotes = [];

      const links = Array.from(doc.querySelectorAll("a"));
      const imgs = Array.from(doc.querySelectorAll("img"));

      if (links.length >= 1){
        const bad = links.filter(a => !a.getAttribute("href") || a.getAttribute("href").trim()==="#" );
        if (bad.length === 0) media += 8;
        else { media += 4; mediaNotes.push("Есть ссылки без корректного href (например, '#')."); }
      } else {
        mediaNotes.push("Нет ссылок (<a>). Рекомендуется добавить хотя бы 1 ссылку (контакты/раздел).");
      }

      if (imgs.length >= 1){
        const missingAlt = imgs.filter(i => !(i.getAttribute("alt")||"").trim());
        if (missingAlt.length === 0) media += 7;
        else { media += 3; mediaNotes.push("У изображений должен быть alt (доступность)."); }
      } else {
        mediaNotes.push("Нет изображений (<img>) — не обязательно, но улучшает главную страницу.");
      }

      results.push({
        id: "links-media",
        name: RUBRIC.find(r=>r.id==="links-media").name,
        score: clamp(media, 0, 15),
        max: 15,
        comment: mediaNotes.length ? mediaNotes.join(" ") : "Ссылки и изображения оформлены корректно."
      });

      // 5) Валидность/грубые ошибки
      let validity = 10;
      const validityNotes = [];

      // Примитивные красные флаги
      const hasBodyText = (doc.body?.textContent || "").replace(/\s+/g,"").length > 0;
      if (!hasBodyText){
        validity -= 7;
        validityNotes.push("Похоже, тело страницы пустое или почти пустое.");
      }

      // Подозрение на “не HTML файл”
      if (!hasHTML || !hasHead || !hasBody){
        validity -= 3;
        validityNotes.push("Структура документа неполная (html/head/body).");
      }

      validity = clamp(validity, 0, 10);
      results.push({
        id: "validity",
        name: RUBRIC.find(r=>r.id==="validity").name,
        score: validity,
        max: 10,
        comment: validityNotes.length ? validityNotes.join(" ") : "Грубых ошибок не обнаружено."
      });

      const total = results.reduce((s,r)=>s+r.score,0);
      const max = results.reduce((s,r)=>s+r.max,0);

      log.push(`[Локальная проверка] Файл: ${loaded.filename || "—"}`);
      log.push(`Сумма: ${total}/${max}`);
      log.push(`Теги: html=${hasHTML}, head=${hasHead}, body=${hasBody}, title=${hasTitle}, h1=${hasH1}, p=${hasP}`);
      log.push(`Текст (примерно): ${text.length} символов`);
      log.push(`Ссылки: ${links.length}, Изображения: ${imgs.length}`);

      return { mode:"local", total, max, results, log };
    }

    function renderReport(report){
      loaded.lastReport = report;

      els.totalScore.textContent = String(report.total);
      els.totalMax.textContent = String(report.max);

      const rows = report.results.map(r => `
        <tr>
          <td><b>${escapeHtml(r.name)}</b></td>
          <td class="score">${r.score}</td>
          <td>${r.max}</td>
          <td>${escapeHtml(r.comment || "")}</td>
        </tr>
      `).join("");

      els.reportBody.innerHTML = rows || `<tr><td colspan="4" class="muted">Нет данных.</td></tr>`;
      setLog(report.log || "—");

      els.btnDownload.disabled = false;
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function toCSV(report){
      const header = ["Критерий","Баллы","Макс","Пояснение"];
      const lines = [header];
      for (const r of report.results){
        lines.push([r.name, String(r.score), String(r.max), (r.comment||"")]);
      }
      lines.push(["ИТОГО", String(report.total), String(report.max), report.mode==="ai" ? "Проверка с ИИ" : "Локальная проверка"]);
      return lines.map(row => row.map(cell => `"${String(cell).replaceAll('"','""')}"`).join(",")).join("\n");
    }

    function downloadCSV(report){
      const csv = toCSV(report);
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const base = (loaded.filename || "report").replace(/\.[^.]+$/,"");
      a.href = url;
      a.download = `${base}_report.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ----------------------------
    // AI режим (опционально):
    // Делается через серверный эндпоинт /api/grade.
    // На GitHub Pages "как есть" работать не будет, пока вы не сделаете backend (Cloudflare Workers / Vercel / Render).
    // ----------------------------
    async function scoreWithAI(htmlText){
      const payload = {
        filename: loaded.filename,
        rubric: RUBRIC,
        html: htmlText
      };

      // ВАЖНО: здесь НЕТ API ключа, он должен быть на сервере.
      const res = await fetch("/api/grade", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });

      if (!res.ok){
        const t = await res.text().catch(()=> "");
        throw new Error(`AI endpoint error: ${res.status} ${t}`.slice(0,400));
      }
      const data = await res.json();

      // Ожидаемый формат ответа сервера:
      // { mode:"ai", total: number, max: number, results:[{id,name,score,max,comment}], log:[...optional] }
      return data;
    }

    // ----------------------------
    // Events
    // ----------------------------
    els.fileInput.addEventListener("change", async (e) => {
      const f = e.target.files?.[0];
      if (!f){
        resetAll();
        return;
      }
      loaded.filename = f.name;
      els.fileMeta.textContent = `${f.name} • ${(f.size/1024).toFixed(1)} KB`;

      const text = await f.text();
      loaded.text = text;

      els.preview.textContent = safeTextPreview(text);

      els.btnCheck.disabled = false;
      els.btnCheckAI.disabled = false;
      els.btnReset.disabled = false;

      setLog("Файл загружен. Нажмите «Проверить».");
    });

    els.btnCheck.addEventListener("click", () => {
      if (!loaded.text) return;
      const report = scoreLocal(loaded.text);
      renderReport(report);
    });

    els.btnCheckAI.addEventListener("click", async () => {
      if (!loaded.text) return;
      setLog("ИИ-проверка запущена… (ожидается ответ сервера /api/grade)");
      try{
        const report = await scoreWithAI(loaded.text);
        renderReport(report);
      }catch(err){
        // Если сервера нет — не падаем, а объясняем
        const msg = String(err?.message || err);
        setLog([
          "Не удалось выполнить ИИ-проверку.",
          "Причина: не найден или не настроен серверный эндпоинт /api/grade.",
          "Решение: используйте кнопку «Проверить» (локально) или подключите backend (Vercel/Render/Cloudflare Workers).",
          "",
          "Техническая деталь:",
          msg
        ]);
      }
    });

    els.btnReset.addEventListener("click", resetAll);

    els.btnDownload.addEventListener("click", () => {
      if (!loaded.lastReport) return;
      downloadCSV(loaded.lastReport);
    });

    // init
    (function(){
      els.totalMax.textContent = "100";
      resetAll();
    })();
  </script>
</body>
</html>
